# `sdk` @libp2p/observer-sdk

This package contains the core React hooks and components on which LibP2P Observer widgets are built. It is also used for other LibP2P Observer UIs such as the [catalogue](../catalogue) and [shell](../shell).

## 1. Usage

### 1.1 Including the SDK in a widget

To create a LibP2P Observer data visualisation widget, use the [create-widget](../create-widget) script. This sets up a new repository including this package alongside Webpack and Storybook configuration, setting the widget up to be compatible with LibP2P Observer [Catalogues](../catalogue)and to run inside the LibP2P Observer [Shell](../shell).

### 1.2 Including the SDK in any other project

The following is intended for use cases where `create-widget` does not apply. It may be skipped if using `create-widget`, as this configured automatically by that script.

#### 1.2.1 Recommended dependency type 

To use this package as a base for other types of UI, choose the [type of dependency](https://classic.yarnpkg.com/en/docs/dependency-types/) which this package should be depending on based on whether the project is standalone:

 - If the project is intended to run alongside or inside the LibP2P Observer Catalogue, include this package as a *peer dependency*, so that only one version of this package and its dependencies can be included in the build, and also as a *dev dependency*, so that it is available locally during development for use (for example, for use with Storybook and Jest).
 - If the project is standalone and independent of the catalogue, for example if it is alternative to or fork of the LibP2P Catalogue, include this package as an ordinary dependency.

 #### 1.2.2 Webpack config

 This package exports font files, it is recommended to use `file-loader` with a test matching at least the `otf` extension. 
 
 Configuration including the following is recommended, as it covers fonts as well as other useful file types including sample binary files in the [samples](../samples) package and the markdown files and PNG images used in standard LibP2P widgets:

```js
return {
  module: {
    rules: [
      {
        // Exports these as raw text
        test: /\.md$/,
        loader: 'raw-loader',
      },
      {
        // Bundles these as files and exports URIs
        test: /\.(png|woff|woff2|eot|ttf|otf|svg|mock)$/,
        loader: 'file-loader',
      },
    ],
  }
}
```

Config including rules like these is automatically generated by the [`create-widget`](../create-widget) script.

## Exports by type

This package exports React Hooks, React Components (which include context providers), theming including fonts and utility functions. Some familiarity or experience with [React Hooks](https://reactjs.org/docs/hooks-overview.html) is recommended. 

### Hooks

Most custom hooks in this SDK accept one object argument, `props`, which destructured like a component's props and type-checked using [`prop-types`](https://github.com/facebook/prop-types) and [...]. This means developers using the SDK can benefit from browser console mistyping warnings and easy in-code type guidance for hooks, the same as for components.

However, because this is a convenience specific to this repo and not a mandated rule of React Hooks, completeness of prop types are not automatially checked by lint.

Anywhere the argument is given as `props`, the prop types are described in the linked file.

#### `useAreaChart( props )`

Consumes the output of `useStackedData` along with pixel `height` and `width` dimensions and returns an array of objects containing:

- `key`: The unique key of the `useStackedData` datum. 
- `pathDef`: A string containing a path definition the area shape visualising this datum in a [D3 Area Chart](https://github.com/d3/d3-shape#areas). These may be applied to [SVG `<path>`](](https://developer.mozilla.org/en/docs/Web/SVG/Tutorial/Paths)) elements' `d` attributes, or a [Canvas Path2D](https://developer.mozilla.org/en-US/docs/Web/API/Path2D/Path2D) constructor.


#### `useCalculation( function, array )`

Calls a given function based on types of available context named in the given array, and caches its result using React's [`useMemo`](), only repeating the function when one of the named contexts changes. Returns the latest result of the function. 

Intended for use where a complex, performance-heavy calculation using contexts needs to be specified somewhere outside of React's render pipeline then called inside it.

#### `useCanvas( props )`

For given dimensions and optional animation function, returns an object containing: 

- `canvasRef`: a [`useRef`]() object to be passed as a `ref` prop to a `<canvas>` element
- `animationRef`: a [`useRef`]() object which carries status data about the current animation frame and animation transition status
- `getCanvasContext`: a function cached with [`useCallback`] that returns the specified render context of the `<canvas>` element (by default, `CanvasRenderingContext2D`)

This is used to assist drawing Canvas elements that persist on re-renders, resize as their width and height changes (e.g. window resizes) and continue animations through re-renders.

#### `useConsoleAPI( props )`

Exposes LibP2P observer data to the console via the `window` object and prints a description of the data available.

#### `useDatastore( props )`

Manages the central source of LibP2P Introspection data and metadata and returns the current data and updater functions.

The data stored in `useDatastore` represents what is held in memory: data removed here will be unretrievable and up for garbage collection. Any filters selected by the user using UI tools are applied outside of this hook.

An object is returned:

- `states`: An array of states messages, managed with `useReducer`, sorted by end time and with states earlier that the current runtime cutoff time erased; or an empty array. 
- `events`: An array of states messages, managed with `useReducer`, sorted by event time and with events earlier that the current runtime cutoff time erased; or an empty array.
- `runtime`: The current `runtime` message; or `null`
- `peerIds`: An array of peerId strings reflecting current user selections
- `source`: An object containing metadata on the current data source; or `null`

- `setIsLoading( bool )`: A function setting only the `isLoading` key of the data `source`
- `updateData( { states, events, runtime } )`: A function cached with [`useCallback`]() updating an existing dataset with given `states`, `events` or `runtime`
    replaceData,
    removeData,
    setPeerIds,
    updateRuntime,
    setRuntime,
    websocket,
    dispatchWebsocket,
